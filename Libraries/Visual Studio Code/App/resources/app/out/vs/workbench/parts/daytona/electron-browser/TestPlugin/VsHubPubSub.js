var __extends=this.__extends||function(n,t){function i(){this.constructor=n}for(var e in t)t.hasOwnProperty(e)&&(n[e]=t[e]);i.prototype=t.prototype,n.prototype=new i},Microsoft;!function(n){!function(t){"use strict";function i(n,t){var i=n;if(i.readyState===XMLHttpRequest.DONE&&!i.status){var e=new Error("Could not reach the server at '"+t+"'");throw e.number=u.SERVER_UNREACHABLE,e}throw n}var e=1,r=function(){function n(){}return n.prototype.invoke=function(n,t,i){},n}(),o=function(n){function t(t){if(n.call(this),!t)throw new Error("'callback' parameter can't be null/undefined");this._callback=t}return __extends(t,n),t.prototype.invoke=function(n,t,i){this._callback(n,t,i)},t}(r),s=function(){function t(n,t,i,e){this._owner=n,this._pubSubEndpoint=t,this._messageCallback=i,this._disconnectedCallback=e}return t.create=function(n,i,e,r){if(!n)throw new Error("'owner' parameter can't be null / undefined");if(!i)throw new Error("'endpoint' parameter can't be null / undefined");if(!e)throw new Error("'messageCallback' parameter can't be null / undefined");return new t(n,i,new o(e),r)},t.prototype.subscribe=function(n){if(!n||""===n)throw new Error("'topic' parameter can't be null / undefined or the empty string.");if(this._proxy)throw new Error("Subscriber.subscribe called more than once. This is an error as this object assumes only a single call to subscribe.");return this._topic=n,this.subscribeInternal(n)},t.prototype.unsubscribe=function(){var t=this;if(!this._subscriptionId)return this._pendingSubscription?(this._pendingUnsubscription||(this._pendingUnsubscription=this._pendingSubscription.then(function(){return t.unsubscribe()})),this._pendingUnsubscription):n.Plugin.Promise.wrap(null);var i=this._subscriptionId;return this._subscriptionId=null,this._pendingSubscription=null,this._pendingUnsubscription=null,this._ensureProxy().then(function(n){return n.invoke("unsubscribe",i)}).then(function(){t._disconnectedCallback=null,t._proxy.off("PubSubMessageReceivedSubscriberCallback",t._signalRCallback),t._proxy=null,t._connection.stop(!0,!0),t._connection=null})},t.prototype.subscribeInternal=function(n){var t=this;return this._pendingSubscription=this._ensureProxy().then(function(t){return t.invoke("subscribe",n)}).then(function(n){t._subscriptionId=n.SubscriptionId,t._topicURI=n.TopicUri}),this._pendingSubscription},t.prototype._ensureSubscriptionEndpoint=function(){var t=this;if(this._subscriptionEndpoint)return n.Plugin.Promise.wrap(this._subscriptionEndpoint);var r=this._pubSubEndpoint+"/subscriptionendpoint",o={type:"HEAD",url:r,headers:{Accept:"application/json;api-version="+e.toFixed(1)}};return n.Plugin.Utilities.xhr(o).then(function(n){t._subscriptionEndpoint=n.getResponseHeader("Link");var i=n.getResponseHeader("Type");if("signalr"!==i)throw new Error("Expected Type header to be 'signalr' but it was '"+i.toString()+"'");var e=n.getResponseHeader("Rel");if("subscribe-unsubscribe"!==e)throw new Error("Expected Rel header to be 'subscribe-unsubscribe' but it was '"+e.toString()+"'");return t._subscriptionEndpoint},function(n){return i(n,r),null})},t.prototype._ensureConnection=function(){var t=this;return this._connection?n.Plugin.Promise.wrap(this._connection):this._ensureSubscriptionEndpoint().then(function(n){t._connection=$.hubConnection(n);var i=function(){t._disconnectedCallback&&t._disconnectedCallback()};return t._connection.disconnected(i),t._connection.reconnected(function(){t.subscribeInternal(t._topic).done(function(){},function(n){i()})}),t._connection})},t.prototype._ensureProxy=function(){var t=this;return this._proxy?n.Plugin.Promise.wrap(this._proxy):this._ensureConnection().then(function(i){return t._proxy?n.Plugin.Promise.wrap(i):(t._proxy=i.createHubProxy("PubSubHub"),t._signalRCallback=function(n,i,e){t._messageCallback.invoke(n,JSON.parse(i),e)},t._proxy.on("PubSubMessageReceivedSubscriberCallback",t._signalRCallback),i.start())}).then(function(){return t._proxy})},t}(),u=function(){function t(n){if(this._activeSubscriptions={},!n)throw new Error("'endpoint' parameter can't be null / undefined");this._pubSubEndpoint=n}return t.prototype.publish=function(t,r){if(!t)throw new Error("'topic' parameter can't be null / undefined");var o=this._pubSubEndpoint+"/topics/"+t,s={type:"PUT",url:o,headers:{"Content-Type":"application/json;charset=utf-8",Accept:"application/json;api-version="+e.toFixed(1)}};return r&&""!==r&&(s.data=JSON.stringify(r)),n.Plugin.Utilities.xhr(s).then(function(n){n.getResponseHeader("message-status")},function(n){i(n,o)})},t.prototype.subscribe=function(n,t,i){var e=s.create(this,this._pubSubEndpoint,t,i),r=this._activeSubscriptions[n]||(this._activeSubscriptions[n]=[]);return r.push({callback:t,subscriber:e}),e.subscribe(n)},t.prototype.unsubscribe=function(t,i){var e=this._activeSubscriptions[t];if(!e)return n.Plugin.Promise.wrap(null);for(var r=null,o=0;o<e.length;o++)if(e[o].callback===i){r=e[o].subscriber,e.splice(o,1),0===e.length&&delete this._activeSubscriptions[t];break}return r?r.unsubscribe():n.Plugin.Promise.wrap(null)},t.SERVER_UNREACHABLE=262657,t}();t.PubSub=u}(n.VSHub||(n.VSHub={}));n.VSHub}(Microsoft||(Microsoft={}));