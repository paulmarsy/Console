/*!--------------------------------------------------------
 * Copyright (C) Microsoft Corporation. All rights reserved.
 *--------------------------------------------------------*/
"use strict";var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)};define("vs/base/common/actions",["require","exports","vs/base/common/winjs.base","vs/base/common/eventEmitter","vs/base/common/events"],function(e,t,n,r,o){function i(e){return e?e instanceof s?!0:"string"!=typeof e.id?!1:"string"!=typeof e.label?!1:"string"!=typeof e["class"]?!1:"boolean"!=typeof e.enabled?!1:"boolean"!=typeof e.checked?!1:"function"!=typeof e.run?!1:!0:!1}t.isAction=i;var s=function(e){function t(t,n,r,o,i){void 0===n&&(n=""),void 0===r&&(r=""),void 0===o&&(o=!0),void 0===i&&(i=null),e.call(this),this._id=t,this._label=n,this._cssClass=r,this._enabled=o,this._actionCallback=i}return __extends(t,e),Object.defineProperty(t.prototype,"id",{get:function(){return this._id},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"label",{get:function(){return this._label},set:function(e){this._setLabel(e)},enumerable:!0,configurable:!0}),t.prototype._setLabel=function(e){this._label!==e&&(this._label=e,this.emit(t.LABEL,{source:this}))},Object.defineProperty(t.prototype,"tooltip",{get:function(){return this._tooltip},set:function(e){this._setTooltip(e)},enumerable:!0,configurable:!0}),t.prototype._setTooltip=function(e){this._tooltip!==e&&(this._tooltip=e,this.emit(t.TOOLTIP,{source:this}))},Object.defineProperty(t.prototype,"class",{get:function(){return this._cssClass},set:function(e){this._setClass(e)},enumerable:!0,configurable:!0}),t.prototype._setClass=function(e){this._cssClass!==e&&(this._cssClass=e,this.emit(t.CLASS,{source:this}))},Object.defineProperty(t.prototype,"enabled",{get:function(){return this._enabled},set:function(e){this._setEnabled(e)},enumerable:!0,configurable:!0}),t.prototype._setEnabled=function(e){this._enabled!==e&&(this._enabled=e,this.emit(t.ENABLED,{source:this}))},Object.defineProperty(t.prototype,"checked",{get:function(){return this._checked},set:function(e){this._setChecked(e)},enumerable:!0,configurable:!0}),t.prototype._setChecked=function(e){this._checked!==e&&(this._checked=e,this.emit(t.CHECKED,{source:this}))},Object.defineProperty(t.prototype,"order",{get:function(){return this._order},set:function(e){this._order=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"actionCallback",{get:function(){return this._actionCallback},set:function(e){this._actionCallback=e},enumerable:!0,configurable:!0}),t.prototype.run=function(e){return null!==this._actionCallback?this._actionCallback(e):n.Promise.as(!0)},t.LABEL="label",t.TOOLTIP="tooltip",t.CLASS="class",t.ENABLED="enabled",t.CHECKED="checked",t}(r.EventEmitter);t.Action=s;var c=(function(e){function t(t,n){e.call(this,t.id,t.label,t["class"],t.enabled,null),this.delegate=t,this.runHandler=n}return __extends(t,e),Object.defineProperty(t.prototype,"id",{get:function(){return this.delegate.id},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"label",{get:function(){return this.delegate.label},set:function(e){this.delegate.label=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"class",{get:function(){return this.delegate["class"]},set:function(e){this.delegate["class"]=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"enabled",{get:function(){return this.delegate.enabled},set:function(e){this.delegate.enabled=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"checked",{get:function(){return this.delegate.checked},set:function(e){this.delegate.checked=e},enumerable:!0,configurable:!0}),t.prototype.run=function(e){return this.runHandler(e),this.delegate.run(e)},t.prototype.addListener=function(e,t){return this.delegate.addListener(e,t)},t.prototype.addBulkListener=function(e){return this.delegate.addBulkListener(e)},t.prototype.addEmitter=function(e,t){return this.delegate.addEmitter(e,t)},t.prototype.addEmitterTypeListener=function(e,t,n){return this.delegate.addEmitterTypeListener(e,t,n)},t.prototype.emit=function(e,t){this.delegate.emit(e,t)},t}(s),function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t.prototype.run=function(e,t){var r=this;return e.enabled?(this.emit(o.EventType.BEFORE_RUN,{action:e}),n.Promise.as(e.run(t)).then(function(t){r.emit(o.EventType.RUN,{action:e,result:t})},function(t){r.emit(o.EventType.RUN,{action:e,error:t})})):n.Promise.as(null)},t}(r.EventEmitter));t.ActionRunner=c}),define("vs/nls!vs/platform/message/common/message",["vs/nls","vs/nls!vs/languages/typescript.workbench/common/projectResolver"],function(e,t){return e.create("vs/platform/message/common/message",t)}),define("vs/platform/message/common/message",["require","exports","vs/nls!vs/platform/message/common/message","vs/base/common/winjs.base","vs/base/common/severity","vs/platform/instantiation/common/instantiation","vs/base/common/actions"],function(e,t,n,r,o,i,s){t.CloseAction=new s.Action("close.message",n.localize(0,null),null,!0,function(){return r.Promise.as(!0)}),t.CancelAction=new s.Action("close.message",n.localize(1,null),null,!0,function(){return r.Promise.as(!0)}),t.IMessageService=i.createDecorator("messageService"),t.Severity=o["default"]}),define("vs/languages/typescript/common/typescript",["require","exports","vs/base/common/winjs.base","vs/platform/platform","vs/base/common/uri"],function(e,t,n,r,o){function i(e){return"string"==typeof e?0===e.indexOf("ts://defaultlib"):"ts"===e.scheme&&"defaultlib"===e.authority}!function(e){e[e.Changed=0]="Changed",e[e.Added=1]="Added",e[e.Removed=2]="Removed"}(t.ChangeKind||(t.ChangeKind={}));var s=t.ChangeKind;t.defaultLib=o["default"].create("ts","defaultlib","/vs/text!vs/languages/typescript/common/lib/lib.d.ts"),t.defaultLibES6=o["default"].create("ts","defaultlib","/vs/text!vs/languages/typescript/common/lib/lib.es6.d.ts"),t.isDefaultLib=i,t.virtualProjectResource=o["default"].create("ts","projects","/virtual/1");var c=function(){function e(){this._needsProjectUpdate=!1,this._fileChanges=[],this._projectChange={kind:s.Changed,resource:t.virtualProjectResource,files:[],options:void 0}}return e.prototype.setConsumer=function(e){this._consumer=e},e.prototype.resolveProjects=function(){var e=[];return this._fileChanges.length&&(e.push(this._consumer.acceptFileChanges(this._fileChanges.slice(0))),this._fileChanges.length=0),this._needsProjectUpdate&&(e.push(this._consumer.acceptProjectChanges([this._projectChange])),this._needsProjectUpdate=!1),n.Promise.join(e)},e.prototype.resolveFiles=function(){},e.prototype.addExtraLib=function(e,t){var n=t?o["default"].file(t):o["default"].create("extralib",void 0,Date.now().toString());this._needsProjectUpdate=!0,this._projectChange.files.push(n),this._fileChanges.push({kind:s.Added,resource:n,content:e})},e.prototype.setCompilerOptions=function(e){this._needsProjectUpdate=!0,this._projectChange.options=e},e}();t.DefaultProjectResolver=c;var a;!function(e){function t(t,n){e.ProjectResolver.addExtraLib(t,n)}function n(t){e.ProjectResolver.setCompilerOptions(t)}e.ProjectResolver=new c,e.addExtraLib=t,e.setCompilerOptions=n}(a=t.Defaults||(t.Defaults={}));var l;!function(e){function t(e){o=e}function n(){return o}e.Identifier="typescript",r.Registry.add(e.Identifier,e);var o;e.setProjectResolver=t,e.getProjectResolver=n}(l=t.Extensions||(t.Extensions={}))});var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},__decorate=this&&this.__decorate||function(e,t,n,r){if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)return Reflect.decorate(e,t,n,r);switch(arguments.length){case 2:return e.reduceRight(function(e,t){return t&&t(e)||e},t);case 3:return e.reduceRight(function(e,r){return void(r&&r(t,n))},void 0);case 4:return e.reduceRight(function(e,r){return r&&r(t,n,e)||e},r)}},__param=this&&this.__param||function(e,t){return function(n,r){t(n,r,e)}};define("vs/languages/typescript.workbench/common/projectResolver",["require","exports","vs/base/common/glob","vs/nls!vs/languages/typescript.workbench/common/projectResolver","vs/base/common/objects","vs/languages/typescript/common/typescript","vs/base/common/lifecycle","vs/base/common/errors","vs/base/common/collections","vs/base/common/async","vs/base/common/winjs.base","vs/base/common/severity","vs/base/common/uri","vs/base/common/paths","vs/languages/typescript/common/lib/typescriptServices","vs/editor/common/services/modelService","vs/platform/event/common/event","vs/platform/files/common/files","vs/platform/markers/common/markers","vs/platform/message/common/message","vs/platform/search/common/search","vs/platform/telemetry/common/telemetry","vs/platform/workspace/common/workspace"],function(e,t,n,r,o,i,s,c,a,l,u,h,d,f,p,v,m,g,_,b,y,j,P){var C,E=["/.git/","/node_modules/","/bower_components/","/jspm_packages/","/tmp/","/temp/"],S=function(){function e(e,t,n){if(this._baseDir=e,this._baseDir=f.normalize(this._baseDir,!0),Array.isArray(t)){this._includes=[];for(var r=0;r<t.length;r++){var o=t[r];this._includes.push(f.normalize(f.join(this._baseDir,o),!0))}}if(Array.isArray(n)){this._excludes=[];for(var i=0;i<n.length;i++){var o=n[i];this._excludes.push(f.normalize(f.join(this._baseDir,o),!0))}}}return e.prototype.handleChange=function(t){for(var n=0,r=e._ignores;n<r.length;n++){var o=r[n];if(-1!==t.fsPath.indexOf(o))return!1}return this._baseDir&&0!==t.fsPath.indexOf(this._baseDir)?!1:this._includes&&this._includes.indexOf(t.fsPath)<0?!1:this._excludes&&this._excludes.some(function(e){return 0===t.fsPath.indexOf(e)})?!1:!0},e._ignores=E.map(function(e){return f.normalize(e,!0)}),e}(),k=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t.prototype.handleChange=function(t){return/\.d\.ts$/.test(t.fsPath)&&e.prototype.handleChange.call(this,t)},t}(S),R=function(){function e(e,t,n,r,o,i,s,c,a,u){this._fileChangeEvents=[],this._projectFileEventListener=Object.create(null),this._projectPromises=Object.create(null),this._pendingFiles=Object.create(null),this._fileService=n,this._searchService=r,this._eventService=o,this._markerService=i,this._messageService=s,this._modelService=c,this._telemetryService=a,this._workspace=u.getWorkspace()&&u.getWorkspace().resource,this._consumer=t,this._configuration=e,this._fileChangesHandler=new l.RunOnceScheduler(this._processFileChangesEvents.bind(this),1e3),this._unbindListener=this._eventService.addListener(g.EventType.FILE_CHANGES,this._onFileChangesEvent.bind(this))}return e.prototype.dispose=function(){s.cAll(this._unbindListener)},e.prototype.setConsumer=function(e){this._consumer=e},e.prototype.resolveProjects=function(){var e=this;if(this._workspace){var t=this._resolve;return t||(t=this._resolve=this._doResolve(),l.always(this._resolve,function(){return e._resolve=null})),new l.ShallowCancelThenPromise(t)}},e.prototype.resolveFiles=function(e){var t=this;if(e=e.filter(function(e){return"file"===e.scheme}),e.length){var n=this._messageService.setStatusMessage(r.localize(0,null),void 0,250),o=this._fileService.resolveContents(e).then(function(e){var n=e.map(function(e){return{kind:i.ChangeKind.Added,content:e.value,resource:e.resource}});return t._consumer.acceptFileChanges(n).then(void 0,function(e){return t._messageService.show(h["default"].Warning,e)})});return l.always(o,function(){return n.dispose()})}},e.prototype._doResolve=function(){var e=this,t={start:Date.now(),d:0,projects:0,files:0},n=this.projectDiscovery().then(function(t){var n=[];for(var r in e._projectPromises)n.push(e._projectPromises[r]),delete e._projectPromises[r];return u.TPromise.join(n)}).then(function(n){return t.projects=n.length,n.length?e._consumer.acceptProjectChanges(n).then(function(t){e._projectsIndex=t[0]}):void 0}).then(function(n){var r=[],s=[],c=o.clone(e._pendingFiles);for(var a in e._pendingFiles){var l=e._pendingFiles[a].kind,u=e._pendingFiles[a].resource;e._pendingFiles[a].kind===i.ChangeKind.Removed?s.push({kind:l,resource:u,content:void 0}):(r.push(u),t.files+=1),delete e._pendingFiles[a]}return r.length?e._fileService.resolveContents(r).then(function(t){return t.forEach(function(e){s.push({resource:e.resource,content:e.value,kind:c[e.resource.toString()].kind}),delete c[e.resource.toString()]}),e._consumer.acceptFileChanges(s).then(void 0,function(t){return e._messageService.show(h["default"].Warning,t)})}):s.length?e._consumer.acceptFileChanges(s).then(void 0,function(t){return e._messageService.show(h["default"].Warning,t)}):void 0}).then(function(e){t.d=Date.now()-t.start});return n},e.prototype.projectDiscovery=function(){var e=this;return this._projectDiscovery||(this._projectDiscovery=this._searchResources(this._configuration.projects).then(function(t){e._resolveProject(i.virtualProjectResource,i.ChangeKind.Added);for(var n=0,r=t.resources;n<r.length;n++){var o=r[n];e._resolveProject(o,i.ChangeKind.Added)}}),this._projectDiscovery.done(void 0,function(t){e._projectDiscovery=null,console.error(t)})),this._projectDiscovery},e.prototype._searchResources=function(t,n,r,o){void 0===n&&(n=1500),void 0===r&&(r=this._workspace);var i={};i[t]=!0;var s=Object.create(null);if(s[e._defaultExcludePattern]=!0,Array.isArray(o))for(var c=0;c<o.length;c++){var a=o[c];a=a.replace(/^[\\\/]/,"").replace(/[\\\/]$/,""),s[a+"/**"]=!0}return this._searchService.search({folderResources:[r],type:y.QueryType.File,maxResults:n,includePattern:i,excludePattern:s}).then(function(e){return{resources:e.results.map(function(e){return e.resource}),limitReached:e.limitHit}})},e.prototype._resolveProject=function(e,t){var n=f.dirname(e.fsPath),r=this._doResolveProject(e,t);this._projectPromises[n]=this._projectPromises[n]&&this._projectPromises[n].then(function(e){return r},function(e){return r})||r,r.done(void 0,function(n){c.isPromiseCanceledError(n)||console.error(e.toString(),t,n)})},e.prototype._doResolveProject=function(e,t){return e.toString()===i.virtualProjectResource.toString()?this._doResolveVirtualProject(t):this._doResolveProjectFile(e,t)},e.prototype._doResolveProjectFile=function(e,t){var n=this;if(this._markerService.remove("ts.projectResolver",[e]),t===i.ChangeKind.Removed)return delete this._projectFileEventListener[e.toString()],u.TPromise.as({kind:t,resource:e,files:void 0,options:void 0});var r={kind:t,resource:e,files:[],options:p.getDefaultCompilerOptions()},o=!1;return this._fileService.resolveContent(e).then(function(t){var i=p.parseConfigFileText(e.fsPath,t.value),s=f.dirname(e.fsPath);if(i.error)return n._markerService.changeOne("ts.projectResolver",e,[{message:i.error.messageText.toString(),code:i.error.code.toString(),severity:h["default"].Error,startLineNumber:1,startColumn:1,endLineNumber:1,endColumn:1}]),u.TPromise.wrapError(c.canceled());if(r.options=p.parseConfigFile(i.config,{readDirectory:function(){return[]}},s).options,n._projectFileEventListener[e.toString()]=new S(s,i.config.files,i.config.exclude),!Array.isArray(i.config.files))return n._searchResources(n._configuration.files,n._configuration.maxFilesPerProject,d["default"].file(s),i.config.exclude).then(function(e){o=e.limitReached,r.files=e.resources});var a=i.config.files.map(function(e){return f.join(s,e)}).map(function(e){return d["default"].file(e)});r.files=a,r.files.length>n._configuration.maxFilesPerProject&&(r.files.length=n._configuration.maxFilesPerProject,o=!0)}).then(function(e){return t===i.ChangeKind.Added&&(r.files.forEach(function(e){return n._pendingFiles[e.toString()]={resource:e,kind:t}}),n._telemetryService.publicLog("js.project",{compilerOptions:r.options,fileCount:r.files.length})),o&&n._telemetryService.publicLog("js.project.fileLimitReached",{maxFilesPerProject:n._configuration.maxFilesPerProject}),r})},e.prototype._doResolveVirtualProject=function(t){var n=this;this._projectFileEventListener[i.virtualProjectResource.toString()]=new k(void 0,void 0,void 0);var r=Object.create(null);return r[e._defaultExcludePatternForVirtualProject]=!0,this._searchService.search({folderResources:[this._workspace],type:y.QueryType.File,maxResults:50,includePattern:{"**/*.d.ts":!0},excludePattern:r}).then(function(e){for(var r=[],o=0,s=e.results;o<s.length;o++){var c=s[o];r.push(c.resource),n._pendingFiles[c.resource.toString()]={resource:c.resource,kind:t}}return{files:r,resource:i.virtualProjectResource,kind:i.ChangeKind.Changed,options:void 0}})},e.prototype._onFileChangesEvent=function(e){(t=this._fileChangeEvents).push.apply(t,e.changes),this._fileChangesHandler.schedule();var t},e.prototype._processFileChangesEvents=function(){var t=this,n=Object.create(null),r=this._fileChangeEvents.slice(0);this._fileChangeEvents.length=0;var o=!1;r.forEach(function(r){var s;if(C.match(t._configuration.projects,r.resource.fsPath))s=e._asChangeKind(r.type),a.lookupOrInsert(n,r.resource.toString(),[]).push(s),o=!0;else if(C.match(t._configuration.files,r.resource.fsPath)){if(s=e._asChangeKind(r.type),s===i.ChangeKind.Changed&&t._modelService.getModel(r.resource))return;a.forEach(t._projectFileEventListener,function(e){e.value.handleChange(r.resource)&&(t._pendingFiles[r.resource.toString()]={kind:s,resource:r.resource},o=!0,(s===i.ChangeKind.Added||s===i.ChangeKind.Removed)&&a.lookupOrInsert(n,e.key,[]).push(i.ChangeKind.Changed))})}});for(var s in n)for(var c=n[s],l=void 0,u=0;u<c.length;u++){var h=c[u];h!==l&&(l=h,this._resolveProject(d["default"].parse(s),h))}o&&this.resolveProjects()},e._lookUpProjects=function(e,t){for(var n,r=f.dirnames(e.fsPath),o=r.next();!o.done;){var i=t[o.value];i&&(n||(n=[]),n.push(i)),o=r.next()}return n},e._asChangeKind=function(e){switch(e){case g.FileChangeType.UPDATED:return i.ChangeKind.Changed;case g.FileChangeType.ADDED:return i.ChangeKind.Added;case g.FileChangeType.DELETED:return i.ChangeKind.Removed}throw new Error("unknown change type")},e._defaultExcludePattern="{"+E.map(function(e){return"**"+e+"**"}).join(",")+"}",e._defaultExcludePatternForVirtualProject="{**/lib*.d.ts,"+E.map(function(e){return"**"+e+"**"}).join(",")+"}",e=__decorate([__param(2,g.IFileService),__param(3,y.ISearchService),__param(4,m.IEventService),__param(5,_.IMarkerService),__param(6,b.IMessageService),__param(7,v.IModelService),__param(8,j.ITelemetryService),__param(9,P.IWorkspaceContextService)],e)}();return function(e){function t(e,t){if("{"===e[0]&&"}"===e[e.length-1]){var n=e.substr(1,e.length-2).split(",");return n.some(function(e){return r(e,t)})}return r(e,t)}function r(e,t){var r=-1;if(0===e.indexOf(o)&&(r=o.length),-1===r)return n.match(e,t);var i=e.substring(r);return i.match(/[.\\\/*]/)?n.match(e,t):(r=t.lastIndexOf(i),-1===r?!1:r+i.length===t.length)}var o="**/*.";e.match=t}(C||(C={})),R});